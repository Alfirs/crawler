from __future__ import annotations

from collections import Counter

from tcpainfinder.models import Category, PainCluster
from tcpainfinder.text import to_one_line
from tcpainfinder.user_profile import OFFERS, PRIMARY_CATEGORIES


def generate_offers_md() -> str:
    lines: list[str] = ['# Офферы (под мои услуги)', ""]
    for idx, o in enumerate(OFFERS, start=1):
        lines.extend(
            [
                f"## Оффер #{idx}: {o.title}",
                f"- Для кого: {o.for_whom}",
                f"- Результат: {o.result}",
                f"- Срок: {o.timeline}",
                f"- Цена: {o.price}",
                "- Что нужно от клиента:",
            ]
        )
        for need in o.needs:
            lines.append(f"  - {need}")
        lines.extend([f"- Быстрый старт сегодня: {o.quick_start}", ""])
    return "\n".join(lines).rstrip() + "\n"


def generate_sales_messages_md() -> str:
    lines: list[str] = ["# Сообщения для продаж (15 шаблонов)", ""]

    lines.append("## В общий чат (3)")
    lines.extend(
        [
            '1) Ребят, если кому-то нужно быстро собрать "бот/интеграцию/таблицу заявок" - могу сделать рабочий запуск за 1-2 дня. Напишите "+" или в личку с 3 пунктами задачи.',
            "2) Вижу, часто спрашивают про автоматизацию: заявки -> таблица/CRM -> уведомления. Могу настроить за 48 часов, чтобы перестало теряться. Кому актуально - в личку.",
            "3) Могу взять 1-2 задачи на эту неделю: бот с приемом заявок, n8n-интеграции, парсинг/отчет, автопостинг из таблицы. Скажи, что нужно - дам сроки и вилку.",
            "",
        ]
    )

    lines.append("## В личку (5)")
    lines.extend(
        [
            '4) Привет! Видел твой запрос. Могу помочь: сделаю быстрый вариант за 1-2 дня (без долгих созвонов). Можно 3 уточнения и я пришлю план + цену?',
            "5) Если задача еще актуальна: сегодня уточняем требования, завтра показываю рабочую версию, послезавтра - финальные правки и передача.",
            "6) Давай начнем с простого: опиши 3-7 пунктов что должно работать и куда складывать заявки. Я отвечу самым быстрым решением и стоимостью.",
            "7) Могу сделать первый шаг сегодня: набросаю схему (какие шаги/интеграции) и покажу, где будут заявки/уведомления. Если ок - запускаю реализацию.",
            "8) Я предложу 2 варианта: минимальный (быстро и дешевле) и под ключ (чтобы не возвращаться к правкам). Какой формат тебе ближе?",
            "",
        ]
    )

    lines.append("## Follow-up (3)")
    lines.extend(
        [
            "9) Привет! Напомню про задачу. Актуально? Могу взять в работу на этой неделе, если подтвердим требования.",
            "10) Привет! Уточню: какой результат тебе нужен через 48 часов? 1-2 пункта - и я предложу самый короткий путь.",
            "11) Привет! Если ок, могу стартовать сегодня: пришли пример/описание и куда складывать заявки - отвечу планом и предоплатой.",
            "",
        ]
    )

    lines.append("## Нет бюджета (2)")
    lines.extend(
        [
            "12) Понял. Тогда можем сделать облегченный вариант: собираю основу (таблица + маршрут заявок + уведомления), а остальное докручиваем позже. Это дешевле и быстро.",
            "13) Ок. Могу начать с мини-диагностики/плана: фиксированная небольшая сумма, я разложу по шагам и дам чек-лист. Дальше можно делать поэтапно.",
            "",
        ]
    )

    lines.append("## Апсейл на поддержку (2)")
    lines.extend(
        [
            "14) После запуска могу взять поддержку: мелкие правки, новые поля, контроль чтобы все работало. Обычно 3 000-7 000 руб/мес.",
            "15) Если хочется без головной боли: 2-4 недели поддержки - докручиваем по факту, добавляем фичи и смотрим что улучшать.",
            "",
        ]
    )

    return "\n".join(lines).rstrip() + "\n"


def _category_summary(clusters: list[PainCluster]) -> str:
    if not clusters:
        return "Нет данных."
    cat_counts = Counter([c.category for c in clusters if c.category in PRIMARY_CATEGORIES])
    if not cat_counts:
        return "Нет явного перекоса по категориям."
    top = cat_counts.most_common(3)
    parts = [f"{cat}={count}" for cat, count in top]
    return ", ".join(parts)


def generate_action_plan_14_days_md(clusters: list[PainCluster]) -> str:
    lines: list[str] = [
        "# План на 14 дней (цель 30-35к)",
        "",
        "## Цель и математика",
        "- Цель: 30 000-35 000 руб за 14 дней",
        "- Вариант A: 2 клиента по 18 000 руб",
        "- Вариант B: 1 клиент 25 000 руб + 1 клиент 10 000 руб",
        "- Предоплата: 50% (старт после предоплаты)",
        "",
        "## Ежедневная норма",
        "- 1 пост в чат",
        "- 20 личных сообщений",
        "- 5 follow-up",
        "",
        "## Что продавать первым",
        "- Приоритет: бот/интеграции/n8n/таблица заявок (быстрый эффект, 1-2 дня).",
        f"- По данным чатов: {_category_summary(list(clusters))}",
        "",
        "## Скрипт закрытия на оплату",
        "1) Уточняю результат: что будет готово через 48 часов.",
        "2) Фиксирую объем: что входит/что не входит.",
        "3) Называю цену и сроки. Предлагаю старт: 50% предоплата -> начинаю сегодня.",
        "",
        "## Что делать сегодня/завтра",
        "### Сегодня",
        "- Открой leads.md и выбери 20-30 самых подходящих лидов.",
        "- Напиши 20 личных сообщений по шаблону (коротко, без полотен).",
        "- Сделай 1 пост в общий чат с оффером на 48 часов.",
        "- Собери 2-3 диалога до конкретики: что нужно, сроки, куда складывать заявки.",
        "",
        "### Завтра",
        "- Закрой 1 диалог на предоплату (предложи слот и дедлайн).",
        "- Начни доставку: сделай рабочую версию (MVP) за 1 день.",
        "- Опубликуй мини-кейс: что было -> что стало (без личных данных).",
        "",
        "## Ритм на 14 дней",
        "- Дни 1-3: лидоген + 1 предоплата.",
        "- Дни 4-6: доставка результата + второй поток лидов.",
        "- Дни 7-10: 1-2 предоплаты + доставка.",
        "- Дни 11-14: добор, апсейл на поддержку, отзывы и мини-кейсы.",
        "",
    ]
    return "\n".join(lines).rstrip() + "\n"


def recommended_offer_for_category(category: Category) -> str:
    # Short label for leads.md
    if category == "Bots_TG_WA_VK":
        return 'Оффер: "Бот + заявки в таблицу"'
    if category == "Integrations_Sheets_CRM_n8n":
        return 'Оффер: "Интеграция n8n -> Sheets/CRM"'
    if category == "Autoposting_ContentFactory":
        return 'Оффер: "Контент-завод / автопостинг"'
    if category == "Parsing_Analytics_Reports":
        return 'Оффер: "Парсинг -> Sheets + отчет"'
    if category == "Landing_Sites":
        return 'Оффер: "Лендинг + форма + аналитика"'
    if category == "Sales_CRM_Process":
        return 'Оффер: "Интеграция/CRM-процесс"'
    if category == "Design_Copy":
        return "Фит низкий (дизайн/копирайт не основной продукт)"
    return "Оффер: быстрая автоматизация (заявки -> таблица -> уведомления)"


def one_line_offer_pitch(category: Category) -> str:
    offer = recommended_offer_for_category(category)
    return to_one_line(offer, max_len=120)

