<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —à–∞–±–ª–æ–Ω–æ–≤ —Å–ª–∞–π–¥–æ–≤</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: #fff;
            border-bottom: 1px solid #ddd;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .header-buttons {
            display: flex;
            gap: 1rem;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn.secondary {
            background: #6c757d;
        }
        
        .btn.secondary:hover {
            background: #545b62;
        }
        
        .main {
            display: flex;
            height: calc(100vh - 70px);
        }
        
        .sidebar {
            width: 300px;
            background: #fff;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }
        
        .canvas-area {
            flex: 1;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            overflow: auto;
        }
        
        .properties-panel {
            width: 300px;
            background: #fff;
            border-left: 1px solid #ddd;
            overflow-y: auto;
        }
        
        .panel-section {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .panel-section h3 {
            margin-bottom: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .canvas {
            width: 540px;
            height: 675px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .template-list {
            padding: 1rem;
        }
        
        .template-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .template-item:hover {
            background: #e9ecef;
        }
        
        .template-item.active {
            background: #cce5ff;
            border-color: #007bff;
        }
        
        .template-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .template-desc {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .zone-item {
            background: rgba(0,123,255,0.1);
            border: 2px solid #007bff;
            position: absolute;
            cursor: move;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #007bff;
            font-weight: 500;
        }
        
        .zone-item.selected {
            border-color: #ff6b6b;
            background: rgba(255,107,107,0.1);
            color: #ff6b6b;
        }
        
        .zone-item.text-zone {
            border-color: #28a745;
            background: rgba(40,167,69,0.1);
            color: #28a745;
        }
        
        .zone-item.image-zone {
            border-color: #ffc107;
            background: rgba(255,193,7,0.1);
            color: #ffc107;
        }
        
        .zone-item.shape-zone {
            border-color: #6f42c1;
            background: rgba(111,66,193,0.1);
            color: #6f42c1;
        }
        
        .toolbar {
            padding: 1rem;
            background: #fff;
            border-bottom: 1px solid #eee;
        }
        
        .toolbar-group {
            margin-bottom: 1rem;
        }
        
        .toolbar-group h4 {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .toolbar-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .tool-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .tool-btn:hover {
            background: #e9ecef;
        }
        
        .tool-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .preview-controls {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —à–∞–±–ª–æ–Ω–æ–≤</h1>
        <div class="header-buttons">
            <button class="btn secondary" onclick="loadTemplate()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            <button class="btn secondary" onclick="saveTemplate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn" onclick="previewTemplate()">–ü—Ä–µ–≤—å—é</button>
        </div>
    </div>
    
    <div class="main">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —Å–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω–æ–≤ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã -->
        <div class="sidebar">
            <div class="panel-section">
                <h3>–®–∞–±–ª–æ–Ω—ã</h3>
                <div id="template-list" class="template-list">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
            
            <div class="toolbar">
                <div class="toolbar-group">
                    <h4>–î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</h4>
                    <div class="toolbar-buttons">
                        <button class="tool-btn" onclick="addZone('text')">üìù –¢–µ–∫—Å—Ç</button>
                        <button class="tool-btn" onclick="addZone('image')">üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                        <button class="tool-btn" onclick="addZone('shape')">‚¨ú –§–∏–≥—É—Ä–∞</button>
                    </div>
                </div>
                
                <div class="toolbar-group">
                    <h4>–§–æ–Ω —Å–ª–∞–π–¥–∞</h4>
                    <div class="toolbar-buttons">
                        <button class="tool-btn" onclick="setBackground('solid')">–¶–≤–µ—Ç</button>
                        <button class="tool-btn" onclick="setBackground('gradient')">–ì—Ä–∞–¥–∏–µ–Ω—Ç</button>
                        <button class="tool-btn" onclick="setBackground('image')">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å - —Ö–æ–ª—Å—Ç -->
        <div class="canvas-area">
            <div class="preview-controls">
                <select id="slide-selector">
                    <option value="0">–°–ª–∞–π–¥ 1 (–û–±–ª–æ–∂–∫–∞)</option>
                    <option value="1">–°–ª–∞–π–¥ 2 (–ö–æ–Ω—Ç–µ–Ω—Ç)</option>
                </select>
                <button class="btn secondary" onclick="addSlide()">+ –î–æ–±–∞–≤–∏—Ç—å —Å–ª–∞–π–¥</button>
            </div>
            
            <div class="canvas" id="canvas">
                <div class="loading">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω</div>
            </div>
        </div>
        
        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - —Å–≤–æ–π—Å—Ç–≤–∞ -->
        <div class="properties-panel">
            <div class="panel-section">
                <h3>–°–≤–æ–π—Å—Ç–≤–∞ —à–∞–±–ª–æ–Ω–∞</h3>
                <div class="form-group">
                    <label>ID —à–∞–±–ª–æ–Ω–∞:</label>
                    <input type="text" id="template-id" placeholder="my_template">
                </div>
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                    <input type="text" id="template-name" placeholder="–ú–æ–π —à–∞–±–ª–æ–Ω">
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea id="template-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞"></textarea>
                </div>
            </div>
            
            <div class="panel-section" id="zone-properties" style="display: none;">
                <h3>–°–≤–æ–π—Å—Ç–≤–∞ —ç–ª–µ–º–µ–Ω—Ç–∞</h3>
                <div id="zone-props-content"></div>
            </div>
        </div>
    </div>

    <script>
        let currentTemplate = null;
        let currentSlideIndex = 0;
        let selectedZone = null;
        let nextZoneId = 1;
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤
        async function loadTemplates() {
            try {
                const response = await fetch('/templates');
                const data = await response.json();
                
                const list = document.getElementById('template-list');
                list.innerHTML = '';
                
                data.templates.forEach(template => {
                    const item = document.createElement('div');
                    item.className = 'template-item';
                    item.onclick = () => selectTemplate(template.id);
                    item.innerHTML = `
                        <div class="template-name">${template.name}</div>
                        <div class="template-desc">${template.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
                        <div class="template-desc">${template.slides_count} —Å–ª–∞–π–¥–æ–≤</div>
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤:', error);
            }
        }
        
        // –í—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞
        async function selectTemplate(templateId) {
            try {
                const response = await fetch(`/templates/${templateId}`);
                const data = await response.json();
                
                if (data.ok) {
                    currentTemplate = data.template;
                    updateUI();
                    renderCanvas();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–∞:', error);
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        function updateUI() {
            if (!currentTemplate) return;
            
            document.getElementById('template-id').value = currentTemplate.id;
            document.getElementById('template-name').value = currentTemplate.name;
            document.getElementById('template-description').value = currentTemplate.description || '';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä —Å–ª–∞–π–¥–æ–≤
            const selector = document.getElementById('slide-selector');
            selector.innerHTML = '';
            currentTemplate.slides.forEach((slide, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `–°–ª–∞–π–¥ ${index + 1} (${slide.name})`;
                selector.appendChild(option);
            });
            selector.value = currentSlideIndex;
            
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —à–∞–±–ª–æ–Ω
            document.querySelectorAll('.template-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeItem = Array.from(document.querySelectorAll('.template-item'))
                .find(item => item.onclick.toString().includes(currentTemplate.id));
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }
        
        // –†–µ–Ω–¥–µ—Ä —Ö–æ–ª—Å—Ç–∞
        function renderCanvas() {
            const canvas = document.getElementById('canvas');
            canvas.innerHTML = '';
            
            if (!currentTemplate || !currentTemplate.slides[currentSlideIndex]) {
                canvas.innerHTML = '<div class="loading">–°–ª–∞–π–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
                return;
            }
            
            const slide = currentTemplate.slides[currentSlideIndex];
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω
            setCanvasBackground(slide.background);
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –∑–æ–Ω—ã
            slide.zones.forEach(zone => {
                renderZone(zone);
            });
        }
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ–Ω–∞ —Ö–æ–ª—Å—Ç–∞
        function setCanvasBackground(background) {
            const canvas = document.getElementById('canvas');
            
            if (background.type === 'solid') {
                canvas.style.background = background.color;
            } else if (background.type === 'gradient') {
                const colors = background.colors.join(', ');
                canvas.style.background = `linear-gradient(${background.direction === 'horizontal' ? 'to right' : 'to bottom'}, ${colors})`;
            } else {
                canvas.style.background = '#f0f0f0';
            }
        }
        
        // –†–µ–Ω–¥–µ—Ä –∑–æ–Ω—ã
        function renderZone(zone) {
            const canvas = document.getElementById('canvas');
            const zoneEl = document.createElement('div');
            
            // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ö–æ–ª—Å—Ç 540x675, —Ä–µ–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä 1080x1350)
            const scale = 0.5;
            
            zoneEl.className = `zone-item ${zone.type}-zone`;
            zoneEl.style.left = (zone.x * scale) + 'px';
            zoneEl.style.top = (zone.y * scale) + 'px';
            zoneEl.style.width = (zone.width * scale) + 'px';
            zoneEl.style.height = (zone.height * scale) + 'px';
            
            // –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–æ–Ω—ã
            if (zone.type === 'text') {
                zoneEl.textContent = zone.content.substring(0, 20) + '...';
            } else if (zone.type === 'image') {
                zoneEl.textContent = 'üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
            } else if (zone.type === 'shape') {
                zoneEl.textContent = zone.shape_type;
            }
            
            zoneEl.onclick = (e) => {
                e.stopPropagation();
                selectZone(zone, zoneEl);
            };
            
            canvas.appendChild(zoneEl);
        }
        
        // –í—ã–±–æ—Ä –∑–æ–Ω—ã
        function selectZone(zone, element) {
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∑–æ–Ω
            document.querySelectorAll('.zone-item').forEach(el => {
                el.classList.remove('selected');
            });
            
            // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∑–æ–Ω—É
            element.classList.add('selected');
            selectedZone = zone;
            
            showZoneProperties(zone);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞ –∑–æ–Ω—ã
        function showZoneProperties(zone) {
            const panel = document.getElementById('zone-properties');
            const content = document.getElementById('zone-props-content');
            
            panel.style.display = 'block';
            
            let html = `
                <div class="form-group">
                    <label>ID:</label>
                    <input type="text" value="${zone.id}" onchange="updateZoneProp('id', this.value)">
                </div>
                <div class="form-group">
                    <label>X:</label>
                    <input type="number" value="${zone.x}" onchange="updateZoneProp('x', parseInt(this.value))">
                </div>
                <div class="form-group">
                    <label>Y:</label>
                    <input type="number" value="${zone.y}" onchange="updateZoneProp('y', parseInt(this.value))">
                </div>
                <div class="form-group">
                    <label>–®–∏—Ä–∏–Ω–∞:</label>
                    <input type="number" value="${zone.width}" onchange="updateZoneProp('width', parseInt(this.value))">
                </div>
                <div class="form-group">
                    <label>–í—ã—Å–æ—Ç–∞:</label>
                    <input type="number" value="${zone.height}" onchange="updateZoneProp('height', parseInt(this.value))">
                </div>
            `;
            
            if (zone.type === 'text') {
                html += `
                    <div class="form-group">
                        <label>–¢–µ–∫—Å—Ç:</label>
                        <textarea onchange="updateZoneProp('content', this.value)">${zone.content}</textarea>
                    </div>
                    <div class="form-group">
                        <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞:</label>
                        <input type="number" value="${zone.font_size}" onchange="updateZoneProp('font_size', parseInt(this.value))">
                    </div>
                    <div class="form-group">
                        <label>–¶–≤–µ—Ç:</label>
                        <input type="color" value="${zone.font_color}" onchange="updateZoneProp('font_color', this.value)">
                    </div>
                `;
            }
            
            content.innerHTML = html;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ –∑–æ–Ω—ã
        function updateZoneProp(prop, value) {
            if (selectedZone) {
                selectedZone[prop] = value;
                renderCanvas();
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–æ–Ω—ã
        function addZone(type) {
            if (!currentTemplate || !currentTemplate.slides[currentSlideIndex]) return;
            
            const slide = currentTemplate.slides[currentSlideIndex];
            const newZone = {
                id: `zone_${nextZoneId++}`,
                type: type,
                x: 100,
                y: 100,
                width: 200,
                height: 100,
                z_index: 1
            };
            
            if (type === 'text') {
                Object.assign(newZone, {
                    content: '–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç',
                    font_family: 'Inter-Regular',
                    font_size: 48,
                    font_color: '#000000',
                    align: 'left',
                    formatting: []
                });
            } else if (type === 'image') {
                Object.assign(newZone, {
                    source: 'ai_generated',
                    ai_prompt: '–∫—Ä–∞—Å–∏–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
                    fit_mode: 'cover'
                });
            } else if (type === 'shape') {
                Object.assign(newZone, {
                    shape_type: 'rectangle',
                    fill_color: '#007bff'
                });
            }
            
            slide.zones.push(newZone);
            renderCanvas();
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
        async function saveTemplate() {
            if (!currentTemplate) return;
            
            try {
                const response = await fetch(`/templates/${currentTemplate.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentTemplate)
                });
                
                const result = await response.json();
                if (result.ok) {
                    alert('–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + result.error);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
            }
        }
        
        // –ü—Ä–µ–≤—å—é —à–∞–±–ª–æ–Ω–∞
        async function previewTemplate() {
            if (!currentTemplate) return;
            
            try {
                const response = await fetch(`/templates/${currentTemplate.id}/preview`);
                const result = await response.json();
                
                if (result.ok) {
                    window.open(result.preview_url, '_blank');
                } else {
                    alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–≤—å—é: ' + result.error);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–µ–≤—å—é: ' + error.message);
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('slide-selector').onchange = function() {
            currentSlideIndex = parseInt(this.value);
            renderCanvas();
        };
        
        // –°–Ω—è—Ç–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ö–æ–ª—Å—Ç
        document.getElementById('canvas').onclick = function() {
            document.querySelectorAll('.zone-item').forEach(el => {
                el.classList.remove('selected');
            });
            selectedZone = null;
            document.getElementById('zone-properties').style.display = 'none';
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = function() {
            loadTemplates();
        };
    </script>
</body>
</html>


