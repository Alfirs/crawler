"""
Instagram Carousel Generator - –æ—Å–Ω–æ–≤–Ω–æ–µ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
"""
import os
import io
import zipfile
import json
import traceback
import glob
import random
from typing import Optional, List
from urllib.parse import quote, unquote

from fastapi import FastAPI, Request, UploadFile, File, Form, HTTPException
from fastapi.responses import HTMLResponse, StreamingResponse, JSONResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates
from PIL import Image, ImageDraw

from .services.neuroapi import chat_complete, image_generate
from .services.render import (
    render_cover,
    render_content,
    image_to_bytes,
    CANVAS_SIZE,
    is_light_image,
    render_slide_with_bg,
    build_bg_from_template,
)
from .services.comic_bg import generate_all_slide_backgrounds
from .services.template_manager import template_manager
from .services.template_renderer import template_renderer
from .schemas.template_schema import CarouselTemplate, RenderContent

# –°–æ–∑–¥–∞—ë–º FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
app = FastAPI(
    title="Instagram Carousel Generator",
    description="–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π MVP –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—É—Å–µ–ª–µ–π Instagram —Å NeuroAPI",
    version="1.0.0"
)

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
OUTPUT_ROOT = os.path.join(BASE_DIR, "static", "outputs")
COMIC_BACKGROUNDS_DIR = os.path.join(BASE_DIR, "static", "comic_backgrounds")
ANALYZE_CACHE = os.path.join(BASE_DIR, "static", "analyze_cache")
os.makedirs(OUTPUT_ROOT, exist_ok=True)
os.makedirs(COMIC_BACKGROUNDS_DIR, exist_ok=True)
os.makedirs(ANALYZE_CACHE, exist_ok=True)

from .services.utils_io import make_run_dir, save_manifest, CANVAS_SIZE, cover_fit, slugify
from .services.image_provider import generate_image_bytes

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —à–∞–±–ª–æ–Ω—ã –∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
templates = Jinja2Templates(directory="app/templates")
app.mount("/static", StaticFiles(directory="app/static"), name="static")
app.mount("/outputs", StaticFiles(directory=OUTPUT_ROOT), name="outputs")

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞ –∫–∞—Ä—É—Å–µ–ª–∏
SYSTEM_PROMPT = (
    "–¢—ã ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä Instagram-–∫–∞—Ä—É—Å–µ–ª–µ–π. –ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É, –±–µ–∑ –≤–æ–¥—ã. "
    "–ù–∏–∫–∞–∫–∏—Ö —ç–º–æ–¥–∑–∏, –º–∞–∫—Å–∏–º—É–º 40‚Äì60 —Å–ª–æ–≤ –Ω–∞ —Å–ª–∞–π–¥. "
    "–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ ‚Äî –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, —Å—Ç—Ä–æ–≥–æ –ø–æ —Å—Ö–µ–º–µ –∏–∑ –∑–∞–¥–∞–Ω–∏—è."
)


def get_random_comic_background() -> Optional[Image.Image]:
    """
    –í—ã–±–∏—Ä–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π —Ñ–æ–Ω –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ comic_backgrounds
    
    Returns:
        PIL Image –æ–±—ä–µ–∫—Ç –∏–ª–∏ None –µ—Å–ª–∏ –∫–∞—Ç–∞–ª–æ–≥ –ø—É—Å—Ç
    """
    try:
        # –ò—â–µ–º —Ç–æ–ª—å–∫–æ .jpg, .jpeg, .png —Ñ–∞–π–ª—ã
        bg_paths = []
        bg_paths.extend(glob.glob(os.path.join(COMIC_BACKGROUNDS_DIR, "*.jpg")))
        bg_paths.extend(glob.glob(os.path.join(COMIC_BACKGROUNDS_DIR, "*.jpeg")))
        bg_paths.extend(glob.glob(os.path.join(COMIC_BACKGROUNDS_DIR, "*.png")))
        
        if not bg_paths:
            return None
        
        # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Ñ–æ–Ω
        bg_path = random.choice(bg_paths)
        bg_img = Image.open(bg_path).convert("RGBA")
        bg_img = cover_fit(bg_img, CANVAS_SIZE)  # –ò—Å–ø–æ–ª—å–∑—É–µ–º cover_fit –≤–º–µ—Å—Ç–æ resize
        
        return bg_img
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ–Ω–∞ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞: {e}")
        return None


def create_fallback_background(color: str = "#2F6F48") -> Image.Image:
    """
    –°–æ–∑–¥–∞—ë—Ç fallback —Ñ–æ–Ω (–∑–∞–ª–∏–≤–∫–∞ —Ü–≤–µ—Ç–æ–º)
    
    Args:
        color: Hex —Ü–≤–µ—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é #2F6F48)
    
    Returns:
        PIL Image —Å –∑–∞–ª–∏—Ç—ã–º —Ñ–æ–Ω–æ–º
    """
    # –ü–∞—Ä—Å–∏–º hex —Ü–≤–µ—Ç
    c = color.lstrip("#")
    if len(c) == 3:
        r, g, b = [int(v * 2, 16) for v in c]
    else:
        r = int(c[0:2], 16)
        g = int(c[2:4], 16)
        b = int(c[4:6], 16)
    
    bg_img = Image.new('RGB', CANVAS_SIZE, (r, g, b))
    return bg_img

# –°—Ç–∏–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
IMAGE_STYLE_PROMPT = (
    "Minimalist editorial illustration for an Instagram carousel slide. "
    "Monochrome or 2-tone palette, clean background, high negative space for text. "
    "Style: vintage engraving + modern flat, soft shadows, high contrast, no clutter. "
    "Aspect: square 1:1, safe composition for top/left text overlay."
)


@app.get("/", response_class=HTMLResponse)
async def ui(request: Request):
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –ø—Ä–æ—Å—Ç—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –≤—ã–±–æ—Ä–∞ —à–∞–±–ª–æ–Ω–∞"""
    return templates.TemplateResponse("simple_ui.html", {"request": request})


@app.get("/advanced", response_class=HTMLResponse)
async def advanced_ui(request: Request):
    """–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—É—Å–µ–ª–∏ (—Å—Ç–∞—Ä—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)"""
    return templates.TemplateResponse("ui.html", {"request": request})


@app.get("/constructor", response_class=HTMLResponse)
async def constructor_ui(request: Request):
    """–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —à–∞–±–ª–æ–Ω–æ–≤ —Å–ª–∞–π–¥–æ–≤"""
    return templates.TemplateResponse("constructor.html", {"request": request})


@app.post("/generate-legacy")
async def generate_carousel_legacy(
    request: Request,
    cover_image: UploadFile = File(..., description="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –æ–±–ª–æ–∂–∫–∏"),
    title: str = Form(..., description="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—É—Å–µ–ª–∏"),
    slides_count: int = Form(..., ge=2, le=10, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–∞–π–¥–æ–≤ (2-10)"),
    prompt: Optional[str] = Form(None, description="–ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è —Ç–µ–º—ã)"),
    use_ai_backgrounds: Optional[str] = Form(None, description="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å AI-—Ñ–æ–Ω—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ ENV)"),
    watermark_text: Optional[str] = Form(None, description="–¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫"),
    watermark_png: Optional[UploadFile] = File(None, description="PNG –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫")
):
    """
    –£–°–¢–ê–†–ï–í–®–ò–ô: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–∞—Ä—É—Å–µ–ª—å —á–µ—Ä–µ–∑ —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ (–æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    """
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–∞—Ä—É—Å–µ–ª—å Instagram –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ZIP –∞—Ä—Ö–∏–≤ —Å–æ —Å–ª–∞–π–¥–∞–º–∏
    """
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if slides_count < 2 or slides_count > 10:
            raise HTTPException(status_code=400, detail="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–∞–π–¥–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 2 –¥–æ 10")
        
        if not title or not title.strip():
            raise HTTPException(status_code=400, detail="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª –æ–±–ª–æ–∂–∫–∏
        if not cover_image.content_type or not cover_image.content_type.startswith('image/'):
            raise HTTPException(status_code=400, detail="–§–∞–π–ª –æ–±–ª–æ–∂–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º")
        
        # 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–ª–∞–Ω –∫–∞—Ä—É—Å–µ–ª–∏ —á–µ—Ä–µ–∑ NeuroAPI
        user_prompt = (
            f'–¢–µ–º–∞: "{title}"\n'
            f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–∞–π–¥–æ–≤ (–≤–∫–ª—é—á–∞—è –æ–±–ª–æ–∂–∫—É): {slides_count}\n\n"
            "–°–¥–µ–ª–∞–π –ø–ª–∞–Ω –∫–∞—Ä—É—Å–µ–ª–∏. –°–ª–∞–π–¥ 1 ‚Äî –æ–±–ª–æ–∂–∫–∞ (—Ç–æ–ª—å–∫–æ –∫—Ä—É–ø–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫). "
            "–°–ª–∞–π–¥—ã 2..N ‚Äî –ø–æ 1 –∫–æ—Ä–æ—Ç–∫–æ–º—É —Ç–µ–∑–∏—Å—É + 2‚Äì5 –ø—É–Ω–∫—Ç–æ–≤ –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è. "
            "–¢–æ–Ω: –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π, —è—Å–Ω—ã–π. –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π. "
            "–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ JSON –ø–æ —Å—Ö–µ–º–µ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π."
        )
        
        raw_plan = await chat_complete(SYSTEM_PROMPT, user_prompt, temperature=0.3)
        
        # –ü–∞—Ä—Å–∏–º JSON –ø–ª–∞–Ω
        try:
            plan = json.loads(raw_plan)
        except (json.JSONDecodeError, TypeError) as e:
            # –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–∏—Ç—å JSON
            repair_prompt = (
                "–í–µ—Ä–Ω–∏ –≤–∞–ª–∏–¥–Ω—ã–π JSON. –ò—Å–ø—Ä–∞–≤—å —Ñ–æ—Ä–º–∞—Ç –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π. "
                "–°—Ö–µ–º–∞: {\"slides\":[{\"idx\":1,\"role\":\"cover\",\"headline\":\"...\"}, "
                "{\"idx\":2,\"role\":\"content\",\"headline\":\"...\",\"bullets\":[\"...\",\"...\"]}], "
                "\"style\":{\"tone\":\"...\",\"target\":\"IG\",\"cta\":\"...\"}}"
            )
            try:
                repair_result = await chat_complete(repair_prompt, f"–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç: {raw_plan}")
                plan = json.loads(repair_result)
            except Exception:
                # –ï—Å–ª–∏ –∏ —ç—Ç–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
                plan = {
                    "slides": [
                        {"idx": 1, "role": "cover", "headline": title},
                        {"idx": 2, "role": "content", "headline": "–û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã", 
                         "bullets": ["–í–∞–∂–Ω—ã–π –ø—É–Ω–∫—Ç 1", "–í–∞–∂–Ω—ã–π –ø—É–Ω–∫—Ç 2", "–í–∞–∂–Ω—ã–π –ø—É–Ω–∫—Ç 3"]}
                    ],
                    "style": {"tone": "–ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π", "target": "IG", "cta": "–õ–∏—Å—Ç–∞–π –¥–∞–ª—å—à–µ"}
                }
        
        slides = plan.get("slides", [])
        if not slides:
            raise HTTPException(status_code=500, detail="–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω –∫–∞—Ä—É—Å–µ–ª–∏")
        
        # 2. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫
        watermark_png_bytes = None
        if watermark_png and watermark_png.filename:
            watermark_png_bytes = await watermark_png.read()
        
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π watermark (–º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑ username –∏–ª–∏ watermark_text)
        watermark_text_final = watermark_text or username
        from .services.watermark import normalize_username
        if watermark_text_final:
            watermark_text_final = normalize_username(watermark_text_final)
            if not watermark_text_final:
                watermark_text_final = None
        else:
            watermark_text_final = None
        
        # 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–æ–Ω—ã –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–Ω—Ç-—Å–ª–∞–π–¥–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞ –∫–∞–∂–¥–æ–≥–æ —Å–ª–∞–π–¥–∞)
        print(f"[generate] Generating backgrounds for {len(slides)} slides...")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ USE_AI_BACKGROUNDS (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true)
        use_ai_bg_env = os.getenv("USE_AI_BACKGROUNDS", "true").lower() in ("1", "true", "yes")
        use_ai_bg = (use_ai_backgrounds or "").lower() in ("1", "true", "yes") if use_ai_backgrounds is not None else use_ai_bg_env
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–æ–Ω—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–Ω—Ç-—Å–ª–∞–π–¥–æ–≤
        slide_backgrounds: List[Optional[Image.Image]] = []
        if use_ai_bg:
            try:
                slide_backgrounds = await generate_all_slide_backgrounds(
                    slides=slides,
                    cache_dir=ANALYZE_CACHE,
                    title=title,
                    use_cache=True
                )
                print(f"[generate] ‚úÖ Generated {len([bg for bg in slide_backgrounds if bg is not None])} backgrounds")
            except Exception as e:
                print(f"[generate] ‚ùå Background generation failed: {type(e).__name__}: {e}")
                traceback.print_exc()
                slide_backgrounds = []
        
        # –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ –∫–æ–Ω—Ç–µ–Ω—Ç-—Å–ª–∞–π–¥–æ–≤ –∫ —Ñ–æ–Ω–∞–º
        content_slide_index = 0
        
        # 4. –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∑–∞–ø—É—Å–∫–∞
        run_dir = make_run_dir(OUTPUT_ROOT, title)
        created_files = []
        
        # 5. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª–∞–π–¥—ã
        zip_buffer = io.BytesIO()
        cover_bytes = await cover_image.read()  # –ß–∏—Ç–∞–µ–º –æ–±–ª–æ–∂–∫—É –æ–¥–∏–Ω —Ä–∞–∑
        
        with zipfile.ZipFile(zip_buffer, "w", zipfile.ZIP_DEFLATED) as zf:
            # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å–ª–∞–π–¥–∞–º
            for i, s in enumerate(slides, start=1):
                try:
                    slide_type = s.get("type", "content")
            
                    if slide_type == "cover" or i == 1:
                        # –û–±–ª–æ–∂–∫–∞ - –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        # AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è –æ–±–ª–æ–∂–∫–∏
                        img = await render_cover(
                            cover_bytes, 
                            title, 
                            watermark_text_final, 
                            watermark_png_bytes,
                            bg_prompt=None,  # –ù–µ –ø–µ—Ä–µ–¥–∞–µ–º –¥–ª—è –æ–±–ª–æ–∂–∫–∏
                            use_ai_bg=False  # –í—Å–µ–≥–¥–∞ False –¥–ª—è –æ–±–ª–æ–∂–∫–∏
                        )
                    else:
                        # –ö–æ–Ω—Ç–µ–Ω—Ç-—Å–ª–∞–π–¥ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞ —Å–ª–∞–π–¥–∞
                        bg_img = None
                        
                        # –ë–µ—Ä–µ–º —Ñ–æ–Ω –∏–∑ –º–∞—Å—Å–∏–≤–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–æ–Ω–æ–≤ (–ø–æ –∏–Ω–¥–µ–∫—Å—É –∫–æ–Ω—Ç–µ–Ω—Ç-—Å–ª–∞–π–¥–∞)
                        if use_ai_bg and slide_backgrounds and content_slide_index < len(slide_backgrounds):
                            bg_img = slide_backgrounds[content_slide_index]
                            content_slide_index += 1
                        
                        # Fallback: –µ—Å–ª–∏ —Ñ–æ–Ω –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª—Å—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–º–∏–∫—Å –∏–ª–∏ —Ü–≤–µ—Ç–Ω–æ–π —Ñ–æ–Ω
                        if bg_img is None:
                            bg_img = get_random_comic_background() or create_fallback_background()
                        
                        # –ü—Ä–∏–º–µ–Ω—è–µ–º cover_fit
                        if bg_img.size != CANVAS_SIZE:
                            bg_img = cover_fit(bg_img, CANVAS_SIZE)
                        bg_img = bg_img.convert("RGBA")
                        
                        # –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç —Å–ª–∞–π–¥–∞
                        title_text = s.get("headline") or s.get("title") or s.get("heading") or s.get("thesis") or ""
                        points = s.get("bullets") or s.get("points") or []
                        thesis = s.get("thesis") or ""
                        
                        body = thesis.strip()
                        if points:
                            body = (body + ("\n\n" if body else "")) + "\n".join([f"‚Üí {p}" for p in points])
                        
                        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ç–µ–∫—Å—Ç–∞ –ø–æ —è—Ä–∫–æ—Å—Ç–∏ —Ñ–æ–Ω–∞
                        is_white = is_light_image(bg_img)
                
                # –†–µ–Ω–¥–µ—Ä–∏–º —Å–ª–∞–π–¥
                        img = await render_content(
                            bg_img=bg_img,
                            title=title_text,
                            bullets=[],
                            body_text=body if body else None,
                            slide_num=i,
                            total_slides=len(slides),
                            is_white_bg=is_white,
                            nickname=None,
                            watermark_text=watermark_text_final,
                            watermark_png=watermark_png_bytes,
                            bg_prompt=None,  # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - —Ñ–æ–Ω —É–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω
                            use_ai_bg=False  # –§–æ–Ω —É–∂–µ –≥–æ—Ç–æ–≤, –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ
                        )
                    
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ –¥–∏—Å–∫ –∏ –≤ ZIP
                    out_name = f"slide_{i:02d}.png"
                    out_path = os.path.join(run_dir, out_name)
                    img.convert("RGB").save(out_path, "PNG")
                    created_files.append({"index": i, "file": out_name})
                    
                    bio = io.BytesIO()
                    img.convert("RGB").save(bio, "PNG")
                    zf.writestr(out_name, bio.getvalue())
                    
                    print(f"[generate] slide {i}/{len(slides)} -> {out_path}  size={img.width}x{img.height}")
                
                except Exception as e:
                    print(f"[generate] –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª–∞–π–¥–∞ {i}: {e}")
                    traceback.print_exc()
                    # –°–æ–∑–¥–∞—ë–º –∑–∞–≥–ª—É—à–∫—É
                    stub_img = Image.new("RGB", CANVAS_SIZE, (40, 40, 40))
                    draw = ImageDraw.Draw(stub_img)
                    draw.text((50, 500), f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª–∞–π–¥–∞", fill=(255, 255, 255))
                    
                    out_name = f"slide_{i:02d}.png"
                    out_path = os.path.join(run_dir, out_name)
                    stub_img.save(out_path, "PNG")
                    created_files.append({"index": i, "file": out_name})
                    
                    bio = io.BytesIO()
                    stub_img.save(bio, "PNG")
                    zf.writestr(out_name, bio.getvalue())
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å–ª–∞–π–¥—ã
        if zip_buffer.tell() == 0:
            raise HTTPException(status_code=500, detail="–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ —Å–ª–∞–π–¥–∞")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç
        save_manifest(run_dir, {
            "title": title,
            "slides_total": len(slides),
            "files": created_files
        })
        
        zip_buffer.seek(0)
        
        print(f"[generate] done. slides={len(slides)} zip_size={zip_buffer.getbuffer().nbytes}")
        print(f"[generate] saved to {run_dir}")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        # –°–æ–∑–¥–∞—ë–º –∏–º—è —Ñ–∞–π–ª–∞ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º (–º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä—É—Å—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã)
        filename = f"carousel_{title[:30]}.zip" if title else "carousel.zip"
        
        # –û—á–∏—â–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –æ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∏—Ä–∏–ª–ª–∏—Ü—É
        filename_cleaned = "".join(c for c in filename if c not in ('<', '>', ':', '"', '/', '\\', '|', '?', '*'))
        
        # –°–æ–∑–¥–∞—ë–º ASCII fallback –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞–º–∏
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—á–∏—â–µ–Ω–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ ASCII –≤–∞—Ä–∏–∞–Ω—Ç–∞
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ ASCII —Å–∏–º–≤–æ–ª—ã (–ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã, –¥–µ—Ñ–∏—Å—ã, –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è)
        safe_filename = "".join(c for c in filename_cleaned if c.isascii() and (c.isalnum() or c in (' ', '-', '_', '.'))).rstrip()
        safe_filename = safe_filename.replace(' ', '_')[:30] if safe_filename and len(safe_filename) > 0 else "carousel"
        # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ .zip –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
        if not safe_filename.endswith('.zip'):
            safe_filename = f"{safe_filename}.zip"
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º RFC 5987 –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤
        encoded_filename = quote(filename_cleaned, safe='')
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ Content-Disposition —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–∞–∫ ASCII fallback, —Ç–∞–∫ –∏ UTF-8 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
        content_disposition = f'attachment; filename="{safe_filename}"; filename*=UTF-8\'\'{encoded_filename}'
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º ZIP —Ñ–∞–π–ª
        return StreamingResponse(
            io.BytesIO(zip_buffer.getvalue()),
            media_type="application/zip",
            headers={"Content-Disposition": content_disposition}
        )
        
    except HTTPException:
        raise  # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º HTTP –æ—à–∏–±–∫–∏ –∫–∞–∫ –µ—Å—Ç—å
    except Exception as e:
        # –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª–Ω—É—é –æ—à–∏–±–∫—É –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        print(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—É—Å–µ–ª–∏: {e}")
        print(traceback.format_exc())
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–Ω—è—Ç–Ω—É—é –æ—à–∏–±–∫—É
        raise HTTPException(
            status_code=500, 
            detail=f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—É—Å–µ–ª–∏: {str(e)}"
        )


@app.post("/generate")
async def generate_carousel_new(
    request: Request,
    cover_image: UploadFile = File(..., description="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –æ–±–ª–æ–∂–∫–∏"),
    title: str = Form(..., description="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—É—Å–µ–ª–∏"),
    slides_count: int = Form(..., ge=2, le=10, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–∞–π–¥–æ–≤ (2-10)"),
    prompt: Optional[str] = Form(None, description="–ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞"),
    template_id: str = Form("instagram_carousel", description="ID —à–∞–±–ª–æ–Ω–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"),
    gradient_color: Optional[str] = Form(None, description="–¶–≤–µ—Ç –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ –¥–ª—è —Ñ–æ–Ω–∞ (hex)")
):
    """
    –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—É—Å–µ–ª–∏ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É —à–∞–±–ª–æ–Ω–æ–≤
    """
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        if slides_count < 2 or slides_count > 10:
            raise HTTPException(status_code=400, detail="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–∞–π–¥–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 2 –¥–æ 10")
        
        if not title or not title.strip():
            raise HTTPException(status_code=400, detail="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
        
        if not cover_image.content_type or not cover_image.content_type.startswith('image/'):
            raise HTTPException(status_code=400, detail="–§–∞–π–ª –æ–±–ª–æ–∂–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º")
        
        # 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–ª–∞–Ω –∫–∞—Ä—É—Å–µ–ª–∏ —á–µ—Ä–µ–∑ NeuroAPI (–∫–∞–∫ –≤ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏)
        user_prompt = (
            f'–¢–µ–º–∞: "{title}"\n'
            f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–∞–π–¥–æ–≤ (–≤–∫–ª—é—á–∞—è –æ–±–ª–æ–∂–∫—É): {slides_count}\n\n"
            "–°–¥–µ–ª–∞–π –ø–ª–∞–Ω –∫–∞—Ä—É—Å–µ–ª–∏. –°–ª–∞–π–¥ 1 ‚Äî –æ–±–ª–æ–∂–∫–∞ (—Ç–æ–ª—å–∫–æ –∫—Ä—É–ø–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫). "
            "–°–ª–∞–π–¥—ã 2..N ‚Äî –ø–æ 1 –∫–æ—Ä–æ—Ç–∫–æ–º—É —Ç–µ–∑–∏—Å—É + 2‚Äì5 –ø—É–Ω–∫—Ç–æ–≤ –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è. "
            "–¢–æ–Ω: –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π, —è—Å–Ω—ã–π. –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π. "
            "–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ JSON –ø–æ —Å—Ö–µ–º–µ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π."
        )
        
        if prompt:
            user_prompt += f"\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–∫–∞–∑–∞–Ω–∏—è: {prompt}"
        
        raw_plan = await chat_complete(SYSTEM_PROMPT, user_prompt, temperature=0.3)
        
        # –ü–∞—Ä—Å–∏–º JSON –ø–ª–∞–Ω
        try:
            plan = json.loads(raw_plan)
        except (json.JSONDecodeError, TypeError) as e:
            # –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–∏—Ç—å JSON
            repair_prompt = (
                "–í–µ—Ä–Ω–∏ –≤–∞–ª–∏–¥–Ω—ã–π JSON. –ò—Å–ø—Ä–∞–≤—å —Ñ–æ—Ä–º–∞—Ç –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π. "
                "–°—Ö–µ–º–∞: {\"slides\":[{\"idx\":1,\"role\":\"cover\",\"headline\":\"...\"}, "
                "{\"idx\":2,\"role\":\"content\",\"headline\":\"...\",\"bullets\":[\"...\",\"...\"]}], "
                "\"style\":{\"tone\":\"...\",\"target\":\"IG\",\"cta\":\"...\"}}"
            )
            try:
                repair_result = await chat_complete(repair_prompt, f"–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç: {raw_plan}")
                plan = json.loads(repair_result)
            except Exception:
                # Fallback
                plan = {
                    "slides": [
                        {"idx": 1, "role": "cover", "headline": title},
                        {"idx": 2, "role": "content", "headline": "–û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã", 
                         "bullets": ["–í–∞–∂–Ω—ã–π –ø—É–Ω–∫—Ç 1", "–í–∞–∂–Ω—ã–π –ø—É–Ω–∫—Ç 2", "–í–∞–∂–Ω—ã–π –ø—É–Ω–∫—Ç 3"]}
                    ],
                    "style": {"tone": "–ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π", "target": "IG", "cta": "–õ–∏—Å—Ç–∞–π –¥–∞–ª—å—à–µ"}
                }
        
        slides = plan.get("slides", [])
        if not slides:
            raise HTTPException(status_code=500, detail="–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω –∫–∞—Ä—É—Å–µ–ª–∏")
        
        # 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–ª–æ–∂–∫—É –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        cover_bytes = await cover_image.read()
        import tempfile
        with tempfile.NamedTemporaryFile(delete=False, suffix=".jpg") as temp_cover:
            temp_cover.write(cover_bytes)
            temp_cover_path = temp_cover.name
        
        # 3. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç RenderContent
        slides_content = []
        
        for i, slide in enumerate(slides):
            if slide.get("role") == "cover" or i == 0:
                # –û–±–ª–æ–∂–∫–∞
                content = RenderContent(
                    title=title,
                    custom_fields={"cover_image_path": temp_cover_path}
                )
            else:
                # –ö–æ–Ω—Ç–µ–Ω—Ç-—Å–ª–∞–π–¥
                headline = slide.get("headline") or slide.get("heading") or slide.get("thesis") or ""
                bullets = slide.get("bullets") or slide.get("points") or []
                
                # –§–æ—Ä–º–∏—Ä—É–µ–º body_text –∏–∑ bullets
                body_text = ""
                if bullets:
                    body_text = "\n".join([f"‚Üí {bullet}" for bullet in bullets])
                
                # –î–æ–±–∞–≤–ª—è–µ–º —Ü–≤–µ—Ç –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ –≤ custom_fields, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
                custom_fields = {}
                if gradient_color:
                    custom_fields["gradient_color"] = gradient_color
                
                content = RenderContent(
                    title=headline,
                    body_text=body_text,
                    bullet_points=bullets,
                    custom_fields=custom_fields
                )
            
            slides_content.append(content)
        
        # 4. –†–µ–Ω–¥–µ—Ä–∏–º —á–µ—Ä–µ–∑ –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É —à–∞–±–ª–æ–Ω–æ–≤
        images = await template_renderer.render_carousel(template_id, slides_content)
        
        # 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
        run_dir = make_run_dir(OUTPUT_ROOT, title)
        created_files = []
        file_urls = []
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—ã–π —Å–ª–∞–π–¥ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª
        for i, img in enumerate(images):
            out_name = f"slide_{i+1:02d}.png"
            out_path = os.path.join(run_dir, out_name)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ –¥–∏—Å–∫
            img.convert("RGB").save(out_path, "PNG")
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –¥–ª—è URL
            rel_path = os.path.relpath(out_path, OUTPUT_ROOT).replace("\\", "/")
            # URL-–∫–æ–¥–∏—Ä—É–µ–º –ø—É—Ç—å –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π
            rel_path_encoded = "/".join(quote(part, safe="") for part in rel_path.split("/"))
            file_url = f"/outputs/{rel_path_encoded}"
            
            created_files.append({
                "index": i+1,
                "file": out_name,
                "path": rel_path,
                "url": file_url
            })
            file_urls.append(file_url)
            
            print(f"[generate] –°–æ—Ö—Ä–∞–Ω–µ–Ω —Å–ª–∞–π–¥ {i+1}/{len(images)}: {out_path}")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç
        run_dir_rel = os.path.relpath(run_dir, OUTPUT_ROOT).replace("\\", "/")
        manifest_data = {
            "title": title,
            "template_id": template_id,
            "slides_total": len(images),
            "files": created_files,
            "generation_method": "template_system",
            "run_dir": run_dir_rel
        }
        save_manifest(run_dir, manifest_data)
        
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –æ–±–ª–æ–∂–∫–∏
        try:
            os.unlink(temp_cover_path)
        except:
            pass
        
        print(f"[generate] ‚úÖ –ö–∞—Ä—É—Å–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: {run_dir}")
        print(f"[generate] –í—Å–µ–≥–æ —Å–ª–∞–π–¥–æ–≤: {len(images)}")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º view_url —á–µ—Ä–µ–∑ endpoint /carousel
        slug, timestamp = run_dir_rel.split("/", 1) if "/" in run_dir_rel else (run_dir_rel, "")
        if timestamp:
            view_url = f"/carousel/{quote(slug, safe='')}/{timestamp}"
        else:
            view_url = f"/slides"
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º JSON —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö
        return JSONResponse({
            "success": True,
            "title": title,
            "template_id": template_id,
            "slides_total": len(images),
            "run_dir": manifest_data["run_dir"],
            "files": created_files,
            "urls": file_urls,
            "view_url": view_url
        })
        
    except HTTPException:
        raise
    except Exception as e:
        print(f"[generate-new] ERROR: {type(e).__name__}: {e}")
        traceback.print_exc()
        raise HTTPException(
            status_code=500,
            detail=f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—É—Å–µ–ª–∏: {str(e)}"
        )


@app.post("/test-photo-overlay")
async def test_photo_overlay(
    image: UploadFile = File(..., description="–§–∞–π–ª —Ñ–æ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —à–∞–±–ª–æ–Ω–∞"),
    slides_text: str = Form(..., description="JSON –º–∞—Å—Å–∏–≤ —Ç–µ–∫—Å—Ç–æ–≤ —Å–ª–∞–π–¥–æ–≤"),
    templates: str = Form(..., description="JSON –º–∞—Å—Å–∏–≤ —Ñ–æ–Ω–æ–≤"),
    size: str = Form("1080x1350", description="–†–∞–∑–º–µ—Ä —Å–ª–∞–π–¥–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä 1080x1350"),
    darken: bool = Form(True, description="–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ")
):
    """
    –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç —Ä–µ–Ω–¥–µ—Ä–∞ —Ñ–æ—Ç–æ+—Ç–µ–∫—Å—Ç –±–µ–∑ AI.
    """
    try:
        texts = json.loads(slides_text)
        template_names = json.loads(templates)
    except json.JSONDecodeError:
        raise HTTPException(status_code=400, detail="slides_text/templates –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º JSON –º–∞—Å—Å–∏–≤–æ–º")

    if not isinstance(texts, list) or not texts:
        raise HTTPException(status_code=400, detail="slides_text –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º —Å—Ç—Ä–æ–∫")
    if not isinstance(template_names, list) or len(template_names) != len(texts):
        raise HTTPException(status_code=400, detail="templates –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º —Ç–æ–π –∂–µ –¥–ª–∏–Ω—ã")

    try:
        width_str, height_str = size.lower().split("x")
        target_size = (int(width_str), int(height_str))
    except Exception:
        raise HTTPException(status_code=400, detail="size –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ WIDTHxHEIGHT (–Ω–∞–ø—Ä–∏–º–µ—Ä 1080x1350)")

    run_dir = make_run_dir(OUTPUT_ROOT, "photo-overlay")
    os.makedirs(run_dir, exist_ok=True)

    image_bytes = await image.read()
    if not image_bytes:
        raise HTTPException(status_code=400, detail="–§–∞–π–ª image –ø—É—Å—Ç–æ–π")
    uploaded_path = os.path.join(run_dir, "user_upload.png")
    with open(uploaded_path, "wb") as f:
        f.write(image_bytes)

    slide_files = []
    for idx, (text_value, template_name) in enumerate(zip(texts, template_names), start=1):
        if not isinstance(text_value, str) or not text_value.strip():
            raise HTTPException(status_code=400, detail=f"–¢–µ–∫—Å—Ç —Å–ª–∞–π–¥–∞ #{idx} –ø—É—Å—Ç–æ–π")

        try:
            bg_image_path, bg_fill = build_bg_from_template(
                template_name,
                upload_path=uploaded_path,
                size=target_size,
            )
        except ValueError as exc:
            raise HTTPException(status_code=400, detail=str(exc))

        rendered = render_slide_with_bg(
            text=text_value.strip(),
            bg_image_path=bg_image_path,
            bg_fill=bg_fill,
            size=target_size,
            darken=darken,
            watermark=None,
        )

        if bg_image_path and bg_image_path != uploaded_path:
            try:
                os.remove(bg_image_path)
            except OSError:
                pass

        filename = f"slide_{idx}.png"
        filepath = os.path.join(run_dir, filename)
        rendered.convert("RGB").save(filepath, "PNG")
        slide_files.append({"index": idx, "file": filename, "path": filepath})

    zip_buffer = io.BytesIO()
    with zipfile.ZipFile(zip_buffer, "w", zipfile.ZIP_DEFLATED) as zf:
        for file_meta in slide_files:
            zf.write(file_meta["path"], arcname=file_meta["file"])

    manifest_payload = {
        "mode": "test-photo-overlay",
        "slides_total": len(slide_files),
        "files": [{"index": f["index"], "file": f["file"]} for f in slide_files],
    }
    save_manifest(run_dir, manifest_payload)

    zip_buffer.seek(0)
    filename = f"photo-overlay-{slugify('photo-overlay')}.zip"
    return StreamingResponse(
        zip_buffer,
        media_type="application/zip",
        headers={"Content-Disposition": f"attachment; filename*=UTF-8''{quote(filename)}"},
    )


@app.get("/analyze", response_class=HTMLResponse)
async def analyze_ui(request: Request):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤"""
    return templates.TemplateResponse("image_analyzer.html", {"request": request})


@app.post("/analyze-image")
async def analyze_image(
    file: UploadFile = File(..., description="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"),
    style: str = Form("", description="–°—Ç–∏–ª—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø—É—Å—Ç–æ–µ = –∂—ë–ª—Ç–æ-—á–µ—Ä–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π —Å—Ç–∏–ª—å –∫–æ–º–∏–∫—Å–æ–≤)"),
    details: Optional[str] = Form(None)
):
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    
    Args:
        file: –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        style: –°—Ç–∏–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø—É—Å—Ç–æ–µ = –∂—ë–ª—Ç–æ-—á–µ—Ä–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π —Å—Ç–∏–ª—å –∫–æ–º–∏–∫—Å–æ–≤)
        details: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
    
    Returns:
        JSON —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞, –ø—Ä–æ–º–ø—Ç–æ–º –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –≤ base64
    """
    try:
        print(f"[FastAPI] –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
        print(f"[FastAPI] –ò–º—è —Ñ–∞–π–ª–∞: {file.filename}")
        print(f"[FastAPI] Content-Type: {file.content_type}")
        print(f"[FastAPI] –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: style='{style}' ({'–¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –∂—ë–ª—Ç–æ-—á–µ—Ä–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π' if not style else '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π'}), details={details}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
        if not file.content_type or not file.content_type.startswith('image/'):
            error_msg = f"–§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º. –ü–æ–ª—É—á–µ–Ω —Ç–∏–ø: {file.content_type}"
            print(f"[FastAPI] –û–®–ò–ë–ö–ê: {error_msg}")
            raise HTTPException(status_code=400, detail=error_msg)
        
        # –ß–∏—Ç–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        print(f"[FastAPI] –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...")
        image_data = await file.read()
        
        if not image_data or len(image_data) == 0:
            error_msg = "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –±—ã–ª–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏–ª–∏ —Ñ–∞–π–ª –ø—É—Å—Ç"
            print(f"[FastAPI] –û–®–ò–ë–ö–ê: {error_msg}")
            raise HTTPException(status_code=400, detail=error_msg)
        
        print(f"[FastAPI] –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ: {len(image_data)} –±–∞–π—Ç")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        try:
            from PIL import Image
            import io
            # –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            img = Image.open(io.BytesIO(image_data))
            # verify() –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Ñ–∞–π–ª, –ø–æ—ç—Ç–æ–º—É –ø–æ—Å–ª–µ –Ω–µ–≥–æ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å
            img.verify()
            # –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            img = Image.open(io.BytesIO(image_data))
            print(f"[FastAPI] –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∞–ª–∏–¥–Ω–æ: {img.format}, —Ä–∞–∑–º–µ—Ä {img.size}")
        except Exception as e:
            error_msg = f"–§–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º: {str(e)}"
            print(f"[FastAPI] –û–®–ò–ë–ö–ê: {error_msg}")
            raise HTTPException(status_code=400, detail=error_msg)
        
        # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑–∞
        from .services.image_analyzer import (
            analyze_image_from_bytes,
            generate_image_from_prompt
        )
        
        print(f"[FastAPI] –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ Vision API...")
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –±–∞–π—Ç–æ–≤ (–±–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤)
        result = await analyze_image_from_bytes(image_data, style=style, details=details)
        
        if not result.get("success", False):
            error_msg = result.get("error", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ")
            raise HTTPException(status_code=500, detail=error_msg)
        
        # –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ì–ï–ù–ï–†–ê–¶–ò–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ–≥–¥–∞, –µ—Å–ª–∏ –ø—Ä–æ–º–ø—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω
        if result.get("prompt"):
            try:
                print(f"[FastAPI] ‚ö° –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–º–ø—Ç–∞...")
                print(f"[FastAPI] –ü—Ä–æ–º–ø—Ç: {result['prompt'][:150]}...")
                
                generated_image_bytes = await generate_image_from_prompt(
                    result["prompt"],
                    size="1024x1024"
                )
                
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64 –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ JSON
                import base64
                image_base64 = base64.b64encode(generated_image_bytes).decode('utf-8')
                
                result["generated_image_base64"] = image_base64
                result["generated_image_size"] = len(generated_image_bytes)
                result["image_generated"] = True
                
                print(f"[FastAPI] ‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: {len(generated_image_bytes)} –±–∞–π—Ç")
                print(f"[FastAPI] ‚úÖ Base64 —Ä–∞–∑–º–µ—Ä: {len(image_base64)} —Å–∏–º–≤–æ–ª–æ–≤")
                
            except Exception as e:
                print(f"[FastAPI] ‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {e}")
                print(traceback.format_exc())
                result["image_generation_error"] = str(e)
                result["image_generated"] = False
                # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –æ—à–∏–±–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        else:
            print(f"[FastAPI] ‚ö†Ô∏è –ü—Ä–æ–º–ø—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
            result["image_generated"] = False
        
        return JSONResponse({
            "success": True,
            **result
        })
        
    except HTTPException:
        raise
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
        print(traceback.format_exc())
        raise HTTPException(
            status_code=500,
            detail=f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {str(e)}"
        )


def latest_run_dir(root: str) -> Optional[str]:
    """
    –ù–∞—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∑–∞–ø—É—Å–∫–∞
    
    Args:
        root: –ö–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è outputs
        
    Returns:
        –ü—É—Ç—å –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏–ª–∏ None
    """
    # outputs/<slug>/<YYYYMMDD_HHMMSS>; –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    candidates = glob.glob(os.path.join(root, "*", "*"))
    if not candidates:
        return None
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    candidates = [c for c in candidates if os.path.isdir(c)]
    if not candidates:
        return None
    
    candidates.sort()
    return candidates[-1]


@app.get("/slides", response_class=HTMLResponse)
async def list_slides():
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç HTML-—Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞
    """
    latest = latest_run_dir(OUTPUT_ROOT)
    if not latest:
        return "<h3>–ù–µ—Ç —Å–ª–∞–π–¥–æ–≤. –°–Ω–∞—á–∞–ª–∞ –≤—ã–∑–æ–≤–∏ POST /generate.</h3>"
    
    files = sorted(glob.glob(os.path.join(latest, "slide_*.png")))
    
    if not files:
        return "<h3>–í –ø–æ—Å–ª–µ–¥–Ω–µ–º —Ä–µ–Ω–¥–µ—Ä–µ –Ω–µ—Ç —Å–ª–∞–π–¥–æ–≤.</h3>"
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
    manifest_path = os.path.join(latest, "manifest.json")
    manifest_info = {}
    if os.path.exists(manifest_path):
        try:
            with open(manifest_path, "r", encoding="utf-8") as f:
                manifest_info = json.load(f)
        except:
            pass
    
    title = manifest_info.get("title", "–ö–∞—Ä—É—Å–µ–ª—å")
    template_id = manifest_info.get("template_id", "unknown")
    slides_total = manifest_info.get("slides_total", len(files))
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º HTML
    html_parts = [
        f'<html><head><meta charset="utf-8"><title>{title}</title></head><body>',
        f'<h1>{title}</h1>',
        f'<p><strong>–®–∞–±–ª–æ–Ω:</strong> {template_id} | <strong>–°–ª–∞–π–¥–æ–≤:</strong> {slides_total}</p>',
        f'<p><strong>–ü–∞–ø–∫–∞:</strong> <code>{os.path.relpath(latest, OUTPUT_ROOT).replace("\\", "/")}</code></p>',
        '<div style="display:flex;flex-wrap:wrap;gap:20px;margin:20px 0;">'
    ]
    
    for f in files:
        name = os.path.basename(f)
        rel = os.path.relpath(f, OUTPUT_ROOT).replace("\\", "/")
        html_parts.append(
            f'<div style="margin:12px;display:inline-block;text-align:center;border:1px solid #ddd;padding:10px;border-radius:8px;">'
            f'<img src="/outputs/{rel}" style="max-width:400px;display:block;margin:auto;border-radius:4px;">'
            f'<br><code style="font-size:12px;">{name}</code>'
            f'</div>'
        )
    
    html_parts.append('</div></body></html>')
    
    return "".join(html_parts)


@app.get("/carousel/{slug:path}/{timestamp}", response_class=HTMLResponse)
async def view_carousel(slug: str, timestamp: str):
    """
    –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–∞—Ä—É—Å–µ–ª–∏ –ø–æ slug –∏ timestamp
    """
    # FastAPI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—É—Ç–∏, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –¥–µ–∫–æ–¥–∏—Ä—É–µ–º –µ—â–µ —Ä–∞–∑
    slug_decoded = unquote(slug)
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—É—Ç—å (—É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ —Å–ª–µ—à–∏)
    slug_decoded = slug_decoded.strip("/").replace("\\", "/")
    carousel_dir = os.path.join(OUTPUT_ROOT, slug_decoded, timestamp)
    
    if not os.path.exists(carousel_dir):
        raise HTTPException(status_code=404, detail=f"–ö–∞—Ä—É—Å–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {slug_decoded}/{timestamp}")
    
    files = sorted(glob.glob(os.path.join(carousel_dir, "slide_*.png")))
    
    if not files:
        raise HTTPException(status_code=404, detail="–í –∫–∞—Ä—É—Å–µ–ª–∏ –Ω–µ—Ç —Å–ª–∞–π–¥–æ–≤")
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç
    manifest_path = os.path.join(carousel_dir, "manifest.json")
    manifest_info = {}
    if os.path.exists(manifest_path):
        try:
            with open(manifest_path, "r", encoding="utf-8") as f:
                manifest_info = json.load(f)
        except:
            pass
    
    title = manifest_info.get("title", "–ö–∞—Ä—É—Å–µ–ª—å")
    template_id = manifest_info.get("template_id", "unknown")
    slides_total = manifest_info.get("slides_total", len(files))
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º HTML
    html_parts = [
        f'<html><head><meta charset="utf-8"><title>{title}</title></head><body>',
        f'<h1>{title}</h1>',
        f'<p><strong>–®–∞–±–ª–æ–Ω:</strong> {template_id} | <strong>–°–ª–∞–π–¥–æ–≤:</strong> {slides_total}</p>',
        f'<p><strong>–ü–∞–ø–∫–∞:</strong> <code>{slug_decoded}/{timestamp}</code></p>',
        '<div style="display:flex;flex-wrap:wrap;gap:20px;margin:20px 0;">'
    ]
    
    for f in files:
        name = os.path.basename(f)
        rel = os.path.relpath(f, OUTPUT_ROOT).replace("\\", "/")
        # URL-–∫–æ–¥–∏—Ä—É–µ–º –ø—É—Ç—å –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        rel_encoded = "/".join(quote(part, safe="") for part in rel.split("/"))
        html_parts.append(
            f'<div style="margin:12px;display:inline-block;text-align:center;border:1px solid #ddd;padding:10px;border-radius:8px;">'
            f'<img src="/outputs/{rel_encoded}" style="max-width:400px;display:block;margin:auto;border-radius:4px;">'
            f'<br><code style="font-size:12px;">{name}</code>'
            f'</div>'
        )
    
    html_parts.append('</div></body></html>')
    
    return "".join(html_parts)


@app.post("/debug/image-gen")
async def debug_image_gen(prompt: str = "angry couple arguing, interior, dramatic, comic illustration"):
    """
    Health-check —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    """
    try:
        print(f"[debug] Starting image generation with prompt: '{prompt[:100]}...'")
        
        raw = await generate_image_bytes(prompt, width=1080, height=1350)
        print(f"[debug] got bytes: {len(raw)}")
        
        img = Image.open(io.BytesIO(raw)).convert("RGBA")
        img = cover_fit(img, CANVAS_SIZE)
        
        print(f"[debug] image processed: {img.size} mode={img.mode}")
        
        out_root = OUTPUT_ROOT
        run_dir = make_run_dir(out_root, f"debug-{slugify(prompt)[:30]}")
        out_path = os.path.join(run_dir, "debug.png")
        img.save(out_path, "PNG")
        
        print(f"[debug] saved to: {out_path}")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –¥–ª—è URL
        # out_path –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ OUTPUT_ROOT, –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ø—É—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ OUTPUT_ROOT
        rel_path = os.path.relpath(out_path, OUTPUT_ROOT)
        rel_path = rel_path.replace("\\", "/")
        
        return JSONResponse({
            "ok": True, 
            "size": list(img.size), 
            "mode": img.mode,
            "bytes_len": len(raw),
            "file": f"/outputs/{rel_path}"
        })
    except Exception as e:
        print(f"[debug] ERROR: {type(e).__name__}: {e}")
        import traceback
        traceback.print_exc()
        return JSONResponse({
            "ok": False, 
            "error": str(e),
            "error_type": type(e).__name__
        }, status_code=500)


# ========== API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —à–∞–±–ª–æ–Ω–∞–º–∏ ==========

@app.get("/templates")
async def list_templates(category: Optional[str] = None):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —à–∞–±–ª–æ–Ω–æ–≤"""
    try:
        templates_list = template_manager.list_templates(category)
        return {"ok": True, "templates": templates_list}
    except Exception as e:
        return JSONResponse({"ok": False, "error": str(e)}, status_code=500)


@app.get("/api/templates/simple")
async def list_templates_simple():
    """–ü–æ–ª—É—á–∏—Ç—å —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
    try:
        presets = template_manager.list_templates("presets")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–±–ª–æ–Ω–∞
        templates_info = {
            "instagram_carousel": {
                "icon": "üì±",
                "name": "Instagram –∫–∞—Ä—É—Å–µ–ª—å", 
                "description": "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Å—Ç–∏–ª—å —Å AI-—Ñ–æ–Ω–∞–º–∏ –∏ –∫–æ–º–∏–∫—Å-–∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è–º–∏"
            },
            "photo_overlay": {
                "icon": "üì∏",
                "name": "–§–æ—Ç–æ —Å –æ–≤–µ—Ä–ª–µ–µ–º",
                "description": "–î–ª—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º"
            },
            "ai_comic_split": {
                "icon": "üé®", 
                "name": "AI –∫–æ–º–∏–∫—Å",
                "description": "–ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å–≤–µ—Ä—Ö—É, —Ç–µ–∫—Å—Ç —Å–Ω–∏–∑—É - –¥–ª—è AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"
            },
            "minimal_text": {
                "icon": "üìù",
                "name": "–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π",
                "description": "–ß–∏—Å—Ç—ã–π –¥–∏–∑–∞–π–Ω –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, —Ç–æ–ª—å–∫–æ —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞"
            }
        }
        
        result = []
        for preset in presets:
            template_id = preset["id"]
            if template_id in templates_info:
                info = templates_info[template_id]
                result.append({
                    "id": template_id,
                    "name": info["name"],
                    "description": info["description"], 
                    "icon": info["icon"],
                    "slides_count": preset["slides_count"]
                })
        
        return {"ok": True, "templates": result}
    except Exception as e:
        return JSONResponse({"ok": False, "error": str(e)}, status_code=500)


@app.get("/templates/{template_id}")
async def get_template(template_id: str):
    """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —à–∞–±–ª–æ–Ω"""
    try:
        template = template_manager.load_template(template_id)
        if not template:
            return JSONResponse({"ok": False, "error": "–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω"}, status_code=404)
        
        return {"ok": True, "template": template.dict()}
    except Exception as e:
        return JSONResponse({"ok": False, "error": str(e)}, status_code=500)


@app.post("/templates")
async def create_template(template_data: dict):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω"""
    try:
        # –í–∞–ª–∏–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        is_valid, error_msg = template_manager.validate_template(template_data)
        if not is_valid:
            return JSONResponse({"ok": False, "error": f"–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —à–∞–±–ª–æ–Ω: {error_msg}"}, status_code=400)
        
        # –°–æ–∑–¥–∞–µ–º —à–∞–±–ª–æ–Ω
        template = CarouselTemplate(**template_data)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º
        filepath = template_manager.save_template(template, "custom")
        
        return {"ok": True, "template_id": template.id, "saved_to": filepath}
    except Exception as e:
        return JSONResponse({"ok": False, "error": str(e)}, status_code=500)


@app.put("/templates/{template_id}")
async def update_template(template_id: str, template_data: dict):
    """–û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —à–∞–±–ª–æ–Ω"""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —à–∞–±–ª–æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        existing = template_manager.load_template(template_id)
        if not existing:
            return JSONResponse({"ok": False, "error": "–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω"}, status_code=404)
        
        # –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ ID —Å–æ–≤–ø–∞–¥–∞–µ—Ç
        template_data["id"] = template_id
        
        # –í–∞–ª–∏–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        is_valid, error_msg = template_manager.validate_template(template_data)
        if not is_valid:
            return JSONResponse({"ok": False, "error": f"–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —à–∞–±–ª–æ–Ω: {error_msg}"}, status_code=400)
        
        # –°–æ–∑–¥–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω
        template = CarouselTemplate(**template_data)
        filepath = template_manager.save_template(template, "custom")
        
        return {"ok": True, "template_id": template.id, "updated": True}
    except Exception as e:
        return JSONResponse({"ok": False, "error": str(e)}, status_code=500)


@app.delete("/templates/{template_id}")
async def delete_template(template_id: str):
    """–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω"""
    try:
        success = template_manager.delete_template(template_id, "custom")
        if not success:
            return JSONResponse({"ok": False, "error": "–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ —É–¥–∞–ª–µ–Ω"}, status_code=404)
        
        return {"ok": True, "deleted": template_id}
    except Exception as e:
        return JSONResponse({"ok": False, "error": str(e)}, status_code=500)


@app.post("/templates/{template_id}/duplicate")
async def duplicate_template(template_id: str, new_name: str = Form(...), new_id: Optional[str] = Form(None)):
    """–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω"""
    try:
        new_template = template_manager.duplicate_template(template_id, new_name, new_id)
        if not new_template:
            return JSONResponse({"ok": False, "error": "–ò—Å—Ö–æ–¥–Ω—ã–π —à–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω"}, status_code=404)
        
        return {"ok": True, "new_template_id": new_template.id, "name": new_template.name}
    except Exception as e:
        return JSONResponse({"ok": False, "error": str(e)}, status_code=500)


@app.get("/templates/{template_id}/preview")
async def preview_template(template_id: str, slide_id: Optional[str] = None):
    """–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–≤—å—é —à–∞–±–ª–æ–Ω–∞"""
    try:
        preview_img = await template_renderer.render_preview(template_id, slide_id)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–≤—å—é –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        preview_dir = os.path.join(OUTPUT_ROOT, "previews")
        os.makedirs(preview_dir, exist_ok=True)
        
        preview_filename = f"{template_id}_{slide_id or 'default'}.png"
        preview_path = os.path.join(preview_dir, preview_filename)
        preview_img.convert("RGB").save(preview_path, "PNG")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º URL
        rel_path = f"previews/{preview_filename}"
        
        return {"ok": True, "preview_url": f"/outputs/{rel_path}"}
    except Exception as e:
        return JSONResponse({"ok": False, "error": str(e)}, status_code=500)


@app.post("/render-template")
async def render_template_endpoint(
    template_id: str = Form(...),
    slides_content: str = Form(...)  # JSON —Å—Ç—Ä–æ–∫–∞ —Å –º–∞—Å—Å–∏–≤–æ–º RenderContent
):
    """–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Ä—É—Å–µ–ª–∏ –ø–æ —à–∞–±–ª–æ–Ω—É"""
    try:
        # –ü–∞—Ä—Å–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç —Å–ª–∞–π–¥–æ–≤
        try:
            slides_data = json.loads(slides_content)
            slides_content_list = [RenderContent(**slide) for slide in slides_data]
        except Exception as e:
            return JSONResponse({"ok": False, "error": f"–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {e}"}, status_code=400)
        
        # –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞—Ä—É—Å–µ–ª—å
        images = await template_renderer.render_carousel(template_id, slides_content_list)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        template = template_manager.load_template(template_id)
        title = template.name if template else template_id
        
        run_dir = make_run_dir(OUTPUT_ROOT, f"template-{title}")
        created_files = []
        
        # –°–æ–∑–¥–∞–µ–º ZIP
        buf = io.BytesIO()
        with zipfile.ZipFile(buf, 'w', zipfile.ZIP_DEFLATED) as zf:
            for i, img in enumerate(images):
                out_name = f"slide_{i+1:02d}.png"
                out_path = os.path.join(run_dir, out_name)
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ –¥–∏—Å–∫
                img.convert("RGB").save(out_path, "PNG")
                created_files.append({"index": i+1, "file": out_name})
                
                # –î–æ–±–∞–≤–ª—è–µ–º –≤ ZIP
                bio = io.BytesIO()
                img.convert("RGB").save(bio, "PNG")
                zf.writestr(out_name, bio.getvalue())
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç
        save_manifest(run_dir, {
            "template_id": template_id,
            "template_name": title,
            "slides_total": len(images),
            "files": created_files
        })
        
        buf.seek(0)
        filename = f"carousel-{slugify(title)}.zip"
        
        return StreamingResponse(
            io.BytesIO(buf.read()),
            media_type="application/zip",
            headers={"Content-Disposition": f"attachment; filename*=UTF-8''{quote(filename)}"}
        )
        
    except Exception as e:
        print(f"[render-template] ERROR: {type(e).__name__}: {e}")
        traceback.print_exc()
        return JSONResponse({"ok": False, "error": str(e)}, status_code=500)


@app.get("/health")
async def health_check():
    """–ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    return {"status": "ok", "message": "Instagram Carousel Generator is running"}


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="127.0.0.1", port=8010, reload=True)



