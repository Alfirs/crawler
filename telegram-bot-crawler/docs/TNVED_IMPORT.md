# Документация: Импорт и поиск ТН ВЭД

## Обзор

Бот использует базу ТН ВЭД (13,279 кодов) из файла Excel от tws.by для точного расчёта таможенных пошлин.

---

## Источники данных

| Источник | Файл | Записей | Использование |
|----------|------|---------|---------------|
| TWS Excel | `TWS_TNVED_2026-02-06.xlsx` | 13,279 | Основной |
| LLM (GPT-4o) | — | — | Fallback если код не найден |

---

## Импорт данных

### Скрипт: `import_excel_tnved.py`

```bash
# Импорт нового Excel файла
python import_excel_tnved.py
```

**Формат Excel (лист "ТНВЭД"):**
| Колонка | Содержимое | Пример |
|---------|------------|--------|
| Код | 9-10 цифр | 101210000 |
| Наименование | Описание товара | лошади: → чистопородные... |
| Тариф | Пошлина в % | 5% |
| Подробности | Ссылка | подробнее |

**База данных:** `data.db`, таблица `tnved_codes`

---

## Поиск кодов

### Алгоритм (`app/domain/search.py`)

```
1. Точное совпадение по коду (confidence: 100%)
   ↓ не найдено
2. Текстовый поиск в локальной БД (токены в описании)
   ↓ результаты слабые
3. LLM-поиск (GPT-4o) — возвращает 3 варианта
```

### Приоритеты
- Если локальные результаты слабые (confidence < 80%) — заменяются на LLM
- ИИ-ставки помечаются символом `≈` в UI

---

## Логи изменений

### 2026-02-06

| Изменение | Файл |
|-----------|------|
| Импортировано 13,279 кодов из Excel | `data.db` |
| Убран fallback `Код 000000000` | `engine.py` |
| Скрыта уверенность (confidence) | `engine.py` |
| Исправлен баг кэширования запроса | `engine.py` |
| LLM заменяет слабые локальные результаты | `search.py` |
| Создан скрипт импорта Excel | `import_excel_tnved.py` |

---

## Проверка данных

```bash
# Количество записей
python -c "import sqlite3; c=sqlite3.connect('data.db').cursor(); c.execute('SELECT COUNT(*) FROM tnved_codes'); print(c.fetchone()[0])"

# Пример: корма
python -c "import sqlite3; c=sqlite3.connect('data.db').cursor(); c.execute('SELECT code, duty_pct*100 FROM tnved_codes WHERE code LIKE \"2309%\" LIMIT 3'); print(c.fetchall())"
```

---

## Обновление базы

1. Скачать новый Excel с https://www.tws.by/tws/tnved
2. Сохранить как `TWS_TNVED_YYYY-MM-DD.xlsx`
3. Обновить имя файла в `import_excel_tnved.py` (строка 10)
4. Запустить: `python import_excel_tnved.py`
