## WbNalogPars

Инструментарий, который закрывает четыре задачи:
1. Работа с API ФНС (налоговая) — вытаскиваем юридические данные, долги, отчётность.  
2. Парсинг визуальных документов (фото, сканы, PDF).  
3. Интеграция с API Wildberries для выгрузки заказов, остатков, финансовых отчётов.  
4. Мини-пайплайн «ИИ‑аналитики» для построения метрик, поиска аномалий и кластеризации SKU.

Проект написан на Python и разнесён по отдельным модулям, чтобы легко заменять источники данных или модели.

### Быстрый старт

```bash
python -m venv .venv
.venv\Scripts\activate
pip install -r requirements.txt
copy .env.example .env  # заполните ключи ФНС и WB
python -m wb_nalog_parsers.cli --help
```

Для Telegram-бота в `.env` добавьте `TELEGRAM_BOT_TOKEN` и при необходимости `TELEGRAM_ALLOWED_USERS` (список `chat_id` через запятую).

### Архитектура модулей

| Модуль | Назначение |
| --- | --- |
| `config.py` | Читает настройки и ключи из `.env`, следит за директориями хранения данных. |
| `nalog_api.py` | Обёртка над REST‑точками ФНС: поиск компании, долги, бухгалтерские отчёты. |
| `wb_api.py` | Клиент к Wildberries Supplier API: заказы, запасы, детальные отчёты. |
| `image_parser.py` | OCR (OpenCV + Tesseract) для извлечения ИНН/КПП/сумм из фото и сканов. |
| `pdf_parser.py` | Парсинг PDF (pdfplumber) c извлечением текста/таблиц. |
| `analytics.py` | «ИИ‑аналитика»: агрегация заказов, поиск аномалий по z-score, кластеризация SKU через KMeans. |
| `cli.py` | Единая точка запуска команд (API-запросы, парсинг, аналитика). |

### Примеры сценариев

#### API ФНС

```bash
python -m wb_nalog_parsers.cli nalog --mode company --inn 7707083893 --output data/nalog.json
python -m wb_nalog_parsers.cli nalog --mode debt --inn 7707083893
```

#### API Wildberries

```bash
python -m wb_nalog_parsers.cli wb --mode orders --date-from 2024-11-01 --status all
python -m wb_nalog_parsers.cli wb --mode report --date-from 2024-11-01 --date-to 2024-11-30
```

#### Парсер изображений / PDF

```bash
python -m wb_nalog_parsers.cli image data/invoice.jpg
python -m wb_nalog_parsers.cli pdf data/invoice.pdf
```

#### Аналитика заказов

```bash
python -m wb_nalog_parsers.cli analytics --orders data/wb_orders.json --output-dir data/analytics
```

В директории появятся `orders_aggregate.csv`, `anomalies.csv`, `sku_clusters.csv`.

### Telegram бот

Бот позволяет выполнять все ключевые действия прямо из чата:

```bash
python -m wb_nalog_parsers.cli bot
```

После запуска бот отправляет кнопочное меню:

- `ФНС API` → выбор действий (компания, долги, отчётность). После выбора бот попросит ввести ИНН/КПП текстом.
- `WB API` → кнопки для заказов, остатков, финансовых отчётов. Где нужно, бот попросит даты текстом.
- `Парсинг изображения` / `Парсинг PDF` / `Аналитика JSON` → бот переключается в режим ожидания файла и обрабатывает его после загрузки.

В любой момент используется кнопка «Назад» или команда `/menu`, чтобы вернуться в главное меню.  
Команды `/nalog` и `/wb` остаются доступными для ручного ввода, но основной сценарий — работа через кнопки.  
По умолчанию бот доступен всем; задайте `TELEGRAM_ALLOWED_USERS=12345,67890`, чтобы ограничить доступ по `chat_id`.

### Как построить «ИИ‑аналитику»

1. **Сбор данных.**  
   - ФНС: юридические события, задолженности, смена статусов.  
   - WB: заказы, цены, возвраты, остатки.  
   - Визуальные документы: проверка реквизитов поставщиков.
2. **Создание витрин.**  
   Используйте `analytics.aggregate_orders`, чтобы превратить JSON заказов в DataFrame и собрать метрики (оборот, количество, маржа).
3. **Обогащение признаков.**  
   Добавьте к таблице признаки из ФНС (например, штрафы, наличие задолженностей) и результат парсинга документов (валидность ИНН).
4. **Модели/эвристики.**  
   - `detect_anomalies` подсветит резкие скачки оборотов/логистики.  
   - `cluster_skus` (KMeans) группирует артикула по динамике продаж.  
   - Поверх этого можно натренировать `IsolationForest` или LLM‑агента, который смотрит в агрегаты — код легко расширить.
5. **Визуализация/алерты.**  
   CSV‑выгрузки можно загрузить в Power BI, Metabase или построить отдельный Streamlit‑дашборд.

### Дальнейшие шаги

- Подключить реальные URL/эндпоинты ФНС (АИС НДС, Прозрачный Бизнес, OFD) и обернуть их в соответствующие методы.
- Добавить очередь задач (Celery, RQ) для регулярного сбора данных и кэширования ответов.
- Расширить `ImageParser`/`PDFParser`, обучив кастомные модели (например, layout-parser) вместо простого OCR.
- Объединить данные в единый lakehouse (Parquet/Delta) и использовать версионирование (Dolt, lakeFS).
