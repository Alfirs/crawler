# Telegram-–±–æ—Ç —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç –Ω–∞ aiogram v3, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –∏ –ø—Ä–æ–≤–æ–¥–∏—Ç –∑–∞–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ YCLIENTS API.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- /start –∏ –∏–Ω–ª–∞–π–Ω-–º–µ–Ω—é: ¬´–û –Ω–∞—Å¬ª, ¬´–ö–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è¬ª, ¬´–ó–∞–ø–∏—Å–∞—Ç—å—Å—è¬ª.
- –°–æ–æ–±—â–µ–Ω–∏–µ ¬´–û –Ω–∞—Å¬ª –∏ –∞–¥—Ä–µ—Å –±–µ—Ä—É—Ç—Å—è –∏–∑ `.env`.
- –õ–æ–∫–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ `sendLocation` + —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∞–¥—Ä–µ—Å.
- –ú–∞—Å—Ç–µ—Ä-–ø–æ—Ç–æ–∫: —É—Å–ª—É–≥–∞ ‚Üí –º–∞—Å—Ç–µ—Ä ‚Üí –¥–∞—Ç–∞ ‚Üí —Å–ª–æ—Ç ‚Üí –≤–≤–æ–¥ –∏–º–µ–Ω–∏ –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ‚Üí –∑–∞—è–≤–∫–∞ —á–µ—Ä–µ–∑ YCLIENTS.
- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ (–Ω–µ –±–æ–ª—å—à–µ 10 –ø—É–Ω–∫—Ç–æ–≤ –Ω–∞ —ç–∫—Ä–∞–Ω).
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ E.164 (`+7XXXXXXXXXX`).
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤ YCLIENTS: —Å –∫–ª—é—á–æ–º `data` –∏ –ø–ª–æ—Å–∫–∏—Ö JSON.
- –ö–µ—à —É—Å–ª—É–≥ (TTL 5 –º–∏–Ω—É—Ç) –∏ –ø—Ä–æ—Å—Ç—ã–µ –ª–æ–≥–∏ –∫–ª—é—á–µ–≤—ã—Ö —à–∞–≥–æ–≤.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
tg_salon/
  app/
    __init__.py
    main.py
    config.py
    keyboards.py
    states.py
    yclients_api.py
    handlers/
      __init__.py
      common.py
      booking.py
  .env.example
  requirements.txt
  README.md
  Dockerfile
  docker-compose.yml
```

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

```bash
python -m venv .venv
# Windows
.venv\Scripts\activate
# Linux/macOS
source .venv/bin/activate

pip install -r requirements.txt
cp .env.example .env  # –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω—ã/–∞–¥—Ä–µ—Å
python -m app.main
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞

1. `/start` ‚Äî –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∫–Ω–æ–ø–∫–∏ ¬´üíá –û –Ω–∞—Å¬ª, ¬´üó∫ –ö–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è¬ª, ¬´üóì –ó–∞–ø–∏—Å–∞—Ç—å—Å—è¬ª.
2. ¬´–û –Ω–∞—Å¬ª –≤—ã–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç –∏–∑ `.env`.
3. ¬´–ö–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è¬ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª–æ–∫–∞—Ü–∏—é (55.751244, 37.618423 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) + –∞–¥—Ä–µ—Å.
4. ¬´–ó–∞–ø–∏—Å–∞—Ç—å—Å—è¬ª –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤—Å–µ —à–∞–≥–∏ –∏ –ø—Ä–∏ –º–æ–∫-–æ—Ç–≤–µ—Ç–µ –æ—Ç `create_record` –≤—ã–≤–æ–¥–∏—Ç `–ì–æ—Ç–æ–≤–æ! –ë—Ä–æ–Ω—å ‚Ññ ...`.

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

`.env.example` —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –∫—Ä–æ–º–µ —Ç–æ–∫–µ–Ω–æ–≤:

- `BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞.
- `YCLIENTS_PARTNER_TOKEN`, `YCLIENTS_USER_TOKEN` ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ YCLIENTS.
- `YCLIENTS_COMPANY_ID` ‚Äî ID –∫–æ–º–ø–∞–Ω–∏–∏.
- `ABOUT_TEXT`, `SALON_ADDRESS`, `SALON_LAT`, `SALON_LON` ‚Äî —Ç–µ–∫—Å—Ç—ã –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –º–µ–Ω—é.
- `YCLIENTS_BASE_URL` ‚Äî –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å—Ç–µ–Ω–¥.
- `YCLIENTS_STRICT_V2` ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –æ–∂–∏–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ `data` –≤ –æ—Ç–≤–µ—Ç–∞—Ö.

### –ì–¥–µ –º–µ–Ω—è—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã API

–í `app/yclients_api.py` –≤—ã–Ω–µ—Å–µ–Ω—ã –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã:

```python
SERVICES_PATH = "/services/{company_id}"
STAFF_PATH = "/staff/{company_id}"
FREE_SLOTS_PATH = "/book_times/{company_id}/{staff_id}"
CREATE_RECORD_PATH = "/records/{company_id}"
```

–ï—Å–ª–∏ –≤–∞—à –∏–Ω—Å—Ç–∞–Ω—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥—Ä—É–≥–∏–µ –ø—É—Ç–∏, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–∏ —Å—Ç—Ä–æ–∫–∏.

## –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ YCLIENTS

1. –í –∫–∞–±–∏–Ω–µ—Ç–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –ø–æ–ª—É—á–∏—Ç–µ `PARTNER_TOKEN`.
2. –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–∏–ª–∏ —á–µ—Ä–µ–∑ API) —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ `USER_TOKEN` —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ —á—Ç–µ–Ω–∏–µ —É—Å–ª—É–≥/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π.
3. `COMPANY_ID` —Å–º–æ—Ç—Ä–∏—Ç–µ –≤ URL –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ —á–µ—Ä–µ–∑ API `/companies`.

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω `logging.INFO`. –ü–æ–≤—ã—à–∞–π—Ç–µ —É—Ä–æ–≤–µ–Ω—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `LOGLEVEL=DEBUG` –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º: `LOGLEVEL=DEBUG python -m app.main`.
- –î–ª—è –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞ HTTP –ø—Ä–æ–∫–∏–Ω—å—Ç–µ —Ç—Ä–∞—Ñ–∏–∫ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏: `HTTP_PROXY=http://127.0.0.1:8080 HTTPS_PROXY=http://127.0.0.1:8080 python -m app.main`.
- –î–ª—è –¥–µ–±–∞–≥–∞ `requests` –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å `PYTHONWARNINGS="default"` –∏ `export REQUESTS_CA_BUNDLE=/path/to/cert`, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω MITM.

## Docker

### Dockerfile

- –ë–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ `python:3.11-slim`.
- –ö–æ–ø–∏—Ä—É–µ—Ç –ø—Ä–æ–µ–∫—Ç, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç `python -m app.main`.

### docker-compose.yml

–ü—Ä–æ—Å—Ç–æ–π —Å–µ—Ä–≤–∏—Å `tg_salon_bot`:

```bash
docker-compose up --build
```

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ `.env` (—Å–º–æ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.env` –≤ –∫–æ—Ä–Ω–µ compose).

## –¢–æ—á–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è

- `handlers/booking.py` ‚Äî –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å WebApp-—Ñ–æ—Ä–º—É –∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
- `yclients_api.py` ‚Äî –≥–æ—Ç–æ–≤ –∫ –∑–∞–º–µ–Ω–µ –ø—É—Ç–µ–π –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é –º–µ—Ç–æ–¥–æ–≤ (`services/staff/slots/records`).
- `keyboards.py` ‚Äî –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ webapp-–∫–Ω–æ–ø–∫—É –¥–ª—è –∞–Ω–∫–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞.
- `states.py` ‚Äî –¥–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã).

## –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–æ–≤

```
/start ‚Üí "–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è..."
–û –Ω–∞—Å ‚Üí "–ú—ã —Å–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã..."
–ö–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ + –∞–¥—Ä–µ—Å —Ç–µ–∫—Å—Ç–æ–º
–ó–∞–ø–∏—Å—å ‚Üí "–ì–æ—Ç–æ–≤–æ! –ë—Ä–æ–Ω—å ‚Ññ 12345. –ñ–¥–µ–º —Ç–µ–±—è 12.05 –≤ 14:30."
```

–£–¥–∞—á–Ω–æ–≥–æ —Ä–µ–ª–∏–∑–∞!
